name: provider docs build
on:
  repository_dispatch:
    types:
      - provider
jobs:
  provider-docs-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          path: docs
      - uses: actions/checkout@v2
        with:
          repository: pulumi/pulumi
          path: pulumi
      - uses: actions/checkout@v2
        with:
          repository: ${{ github.event.client_payload.repo }}
          ref: ${{ github.event.client_payload.ref }}
          path: ${{ github.event.client_payload.project }}
      - uses: actions/setup-go@v2
      - uses: actions/setup-node@v2-beta
      - uses: actions/setup-python@v2
      - uses: dschep/install-pipenv-action@v1
      - uses: actions/setup-dotnet@v1
      - run: make ensure ensure_tools
        working-directory: docs
      - name: run typedoc
        run: PKGS=${{ github.event.client_payload.project }} NOBUILD=true ./scripts/run_typedoc.sh
        working-directory: docs
      - name: generate resource docs
        run: ./scripts/gen_resource_docs.sh "${{ github.event.client_payload.project-shortname }}" true "${{ github.event.client_payload.ref }}"
        working-directory: docs
      - name: generate python docs
        run: ./scripts/generate_python_docs.sh "${{ github.event.client_payload.project-shortname }}"
        working-directory: docs
      - name: git status
        run: git status && git diff
        working-directory: docs
      - uses: EndBug/add-and-commit@v4
        with:
          ref: "${{ github.event.client_payload.project-shortname }}/${{ github.run_id }}-${{ github.run_number }}"
          author_name: pulumi-bot
          author_email: "bot@pulumi.com"
          cwd: docs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
